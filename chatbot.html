<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Empire Essence - Chat</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;500;600&display=swap');

:root {
  --gold: #c9a94e;
  --gold-light: #e8d48b;
  --gold-dark: #a07c2a;
  --dark: #0a0a0a;
  --dark-card: #141414;
  --dark-input: #1a1a1a;
  --dark-border: #2a2a2a;
  --text: #f0ece2;
  --text-muted: #8a8578;
}

/* Reset for widget */
#ee-chatbot * { margin:0; padding:0; box-sizing:border-box; }

/* Bubble */
#ee-chat-bubble {
  position: fixed; bottom: 24px; right: 24px; z-index: 99999;
  width: 64px; height: 64px; border-radius: 50%;
  background: linear-gradient(135deg, var(--gold), var(--gold-dark));
  box-shadow: 0 4px 24px rgba(201,169,78,0.4);
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: transform 0.3s, box-shadow 0.3s;
  animation: ee-pulse 2s infinite;
}
#ee-chat-bubble:hover { transform: scale(1.1); box-shadow: 0 6px 32px rgba(201,169,78,0.6); }
#ee-chat-bubble svg { width: 28px; height: 28px; fill: var(--dark); }
@keyframes ee-pulse {
  0%,100% { box-shadow: 0 4px 24px rgba(201,169,78,0.4); }
  50% { box-shadow: 0 4px 32px rgba(201,169,78,0.7); }
}

/* Badge */
#ee-chat-badge {
  position: absolute; top: -4px; right: -4px;
  width: 20px; height: 20px; border-radius: 50%;
  background: #e74c3c; color: #fff; font-size: 11px;
  font-family: 'Montserrat', sans-serif; font-weight: 600;
  display: flex; align-items: center; justify-content: center;
}

/* Chat Window */
#ee-chat-window {
  position: fixed; bottom: 100px; right: 24px; z-index: 99999;
  width: 380px; max-width: calc(100vw - 32px); height: 560px; max-height: calc(100vh - 120px);
  background: var(--dark); border: 1px solid var(--gold-dark);
  border-radius: 16px; overflow: hidden;
  display: none; flex-direction: column;
  box-shadow: 0 8px 48px rgba(0,0,0,0.6), 0 0 0 1px rgba(201,169,78,0.2);
  font-family: 'Montserrat', sans-serif;
}
#ee-chat-window.open { display: flex; animation: ee-slideUp 0.3s ease; }
@keyframes ee-slideUp { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }

/* Header */
#ee-chat-header {
  background: linear-gradient(135deg, var(--dark-card), #1a1a1a);
  border-bottom: 1px solid var(--gold-dark);
  padding: 16px; display: flex; align-items: center; gap: 12px;
  flex-shrink: 0;
}
#ee-chat-header .ee-avatar {
  width: 40px; height: 40px; border-radius: 50%;
  background: linear-gradient(135deg, var(--gold), var(--gold-dark));
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; flex-shrink: 0;
}
#ee-chat-header .ee-info { flex: 1; }
#ee-chat-header .ee-name {
  font-family: 'Playfair Display', serif; color: var(--gold);
  font-size: 15px; font-weight: 700;
}
#ee-chat-header .ee-status { color: var(--text-muted); font-size: 11px; margin-top: 2px; }
#ee-chat-header .ee-status::before {
  content: ''; display: inline-block; width: 7px; height: 7px;
  border-radius: 50%; background: #2ecc71; margin-right: 5px; vertical-align: middle;
}
#ee-chat-close {
  background: none; border: none; color: var(--text-muted); cursor: pointer;
  font-size: 20px; padding: 4px 8px; line-height: 1;
}
#ee-chat-close:hover { color: var(--gold); }

/* Messages */
#ee-chat-messages {
  flex: 1; overflow-y: auto; padding: 16px;
  display: flex; flex-direction: column; gap: 12px;
  scrollbar-width: thin; scrollbar-color: var(--gold-dark) transparent;
}
#ee-chat-messages::-webkit-scrollbar { width: 4px; }
#ee-chat-messages::-webkit-scrollbar-thumb { background: var(--gold-dark); border-radius: 4px; }

.ee-msg {
  max-width: 85%; padding: 10px 14px; border-radius: 16px;
  font-size: 13.5px; line-height: 1.5; color: var(--text);
  animation: ee-fadeIn 0.3s ease;
}
@keyframes ee-fadeIn { from { opacity:0; transform: translateY(8px); } to { opacity:1; transform: translateY(0); } }
.ee-msg.bot {
  background: var(--dark-card); border: 1px solid var(--dark-border);
  border-bottom-left-radius: 4px; align-self: flex-start;
}
.ee-msg.user {
  background: linear-gradient(135deg, var(--gold-dark), rgba(201,169,78,0.3));
  border-bottom-right-radius: 4px; align-self: flex-end;
}
.ee-msg .ee-fragrance-name { color: var(--gold); font-weight: 600; }
.ee-msg .ee-price { color: var(--gold-light); font-weight: 500; }

/* Quick replies */
.ee-quick-replies {
  display: flex; flex-wrap: wrap; gap: 8px; padding: 0 16px 8px;
  flex-shrink: 0;
}
.ee-quick-btn {
  background: var(--dark-card); border: 1px solid var(--gold-dark);
  color: var(--gold); padding: 7px 14px; border-radius: 20px;
  font-size: 12.5px; font-family: 'Montserrat', sans-serif;
  cursor: pointer; transition: all 0.2s; white-space: nowrap;
}
.ee-quick-btn:hover {
  background: var(--gold-dark); color: var(--dark);
  box-shadow: 0 2px 12px rgba(201,169,78,0.3);
}

/* Input */
#ee-chat-input-area {
  padding: 12px 16px; border-top: 1px solid var(--dark-border);
  display: flex; gap: 8px; flex-shrink: 0;
  background: var(--dark-card);
}
#ee-chat-input {
  flex: 1; background: var(--dark-input); border: 1px solid var(--dark-border);
  border-radius: 24px; padding: 10px 16px; color: var(--text);
  font-size: 13px; font-family: 'Montserrat', sans-serif;
  outline: none; transition: border-color 0.2s;
}
#ee-chat-input:focus { border-color: var(--gold-dark); }
#ee-chat-input::placeholder { color: var(--text-muted); }
#ee-chat-send {
  width: 40px; height: 40px; border-radius: 50%;
  background: linear-gradient(135deg, var(--gold), var(--gold-dark));
  border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: transform 0.2s;
}
#ee-chat-send:hover { transform: scale(1.1); }
#ee-chat-send svg { width: 18px; height: 18px; fill: var(--dark); }

/* Typing indicator */
.ee-typing { display: flex; gap: 4px; padding: 10px 14px; align-self: flex-start; }
.ee-typing span {
  width: 7px; height: 7px; border-radius: 50%; background: var(--gold-dark);
  animation: ee-bounce 1.4s infinite;
}
.ee-typing span:nth-child(2) { animation-delay: 0.2s; }
.ee-typing span:nth-child(3) { animation-delay: 0.4s; }
@keyframes ee-bounce { 0%,60%,100% { transform: translateY(0); } 30% { transform: translateY(-8px); } }

/* Product card inside messages */
.ee-product-card {
  background: var(--dark-input); border: 1px solid var(--dark-border);
  border-radius: 12px; padding: 12px; margin-top: 8px;
}
.ee-product-card h4 { color: var(--gold); font-size: 14px; margin-bottom: 4px; }
.ee-product-card .ee-inspired { color: var(--text-muted); font-size: 11px; margin-bottom: 6px; font-style: italic; }
.ee-product-card .ee-notes { color: var(--text); font-size: 12px; line-height: 1.5; }
.ee-product-card .ee-note-label { color: var(--gold-dark); font-weight: 500; }
</style>
</head>
<body>
<div id="ee-chatbot">
  <!-- Bubble -->
  <div id="ee-chat-bubble" onclick="EEChat.toggle()">
    <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.2L4 17.2V4h16v12z"/><path d="M7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/></svg>
    <div id="ee-chat-badge" style="display:none">1</div>
  </div>

  <!-- Window -->
  <div id="ee-chat-window">
    <div id="ee-chat-header">
      <div class="ee-avatar">ğŸ‘‘</div>
      <div class="ee-info">
        <div class="ee-name">Empire Essence</div>
        <div class="ee-status">En lÃ­nea</div>
      </div>
      <button id="ee-chat-close" onclick="EEChat.toggle()">âœ•</button>
    </div>
    <div id="ee-chat-messages"></div>
    <div class="ee-quick-replies" id="ee-quick-replies"></div>
    <div id="ee-chat-input-area">
      <input id="ee-chat-input" type="text" placeholder="Escribe tu mensaje..." autocomplete="off">
      <button id="ee-chat-send" onclick="EEChat.sendUserInput()">
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>
</div>

<script>
const EEChat = (() => {
// â”€â”€ CatÃ¡logo â”€â”€
const catalog = [
  {id:1,name:"Aventus",inspired:"Creed Aventus",cat:"masculina",top:["piÃ±a","grosella negra","manzana","bergamota"],heart:["abedul","pachulÃ­","rosa","jazmÃ­n"],base:["musgo de roble","almizcle","Ã¡mbar gris","vainilla"],desc:"Frutal y audaz con un corazÃ³n ahumado de abedul. IcÃ³nico aroma de poder y sofisticaciÃ³n.",tags:["frutal","amaderado","elegante","poder","oficina","cita"]},
  {id:2,name:"Sauvage",inspired:"Dior Sauvage",cat:"masculina",top:["bergamota","pimienta"],heart:["lavanda","vetiver","pachulÃ­","geranio"],base:["ambroxan","cedro","lÃ¡dano"],desc:"Fresco y salvaje con bergamota vibrante y fondo amaderado potente.",tags:["fresco","amaderado","versÃ¡til","diario","casual","cita"]},
  {id:3,name:"One Million",inspired:"Paco Rabanne One Million",cat:"masculina",top:["mandarina","pomelo","menta"],heart:["canela","especiadas","rosa"],base:["Ã¡mbar","cuero","pachulÃ­"],desc:"Dulce, especiado y magnÃ©tico. Canela y Ã¡mbar que irradian confianza.",tags:["dulce","especiado","noche","fiesta","seductor"]},
  {id:4,name:"Invictus",inspired:"Paco Rabanne Invictus",cat:"masculina",top:["notas marinas","pomelo","mandarina"],heart:["laurel","jazmÃ­n"],base:["Ã¡mbar gris","guayaco","musgo de roble"],desc:"AcuÃ¡tico y fresco con toque atlÃ©tico. EnergÃ­a y frescura.",tags:["fresco","acuÃ¡tico","deportivo","diario","joven"]},
  {id:5,name:"Bleu",inspired:"Bleu de Chanel",cat:"masculina",top:["limÃ³n","bergamota","menta"],heart:["lavanda","geranio"],base:["sÃ¡ndalo","cedro","Ã¡mbar","haba tonka"],desc:"Elegante y versÃ¡til con cÃ­tricos frescos y maderas cÃ¡lidas.",tags:["elegante","versÃ¡til","oficina","cita","amaderado","cÃ­trico"]},
  {id:6,name:"Le Male",inspired:"JPG Le Male",cat:"masculina",top:["lavanda","menta","cardamomo"],heart:["canela","flor de naranjo"],base:["vainilla","haba tonka","sÃ¡ndalo"],desc:"ClÃ¡sico con lavanda fresca y vainilla cÃ¡lida. Seductor y reconfortante.",tags:["dulce","clÃ¡sico","seductor","noche","cita"]},
  {id:7,name:"212 VIP Men",inspired:"CH 212 VIP Men",cat:"masculina",top:["maracuyÃ¡","lima","pimienta"],heart:["vodka","ginebra","menta"],base:["Ã¡mbar","cuero"],desc:"Vibrante y festivo con frutas tropicales y toque licoroso.",tags:["fiesta","nocturno","frutal","joven","tropical"]},
  {id:8,name:"Bad Boy",inspired:"CH Bad Boy",cat:"masculina",top:["pimienta blanca","bergamota"],heart:["cedro","salvia"],base:["haba tonka","cacao"],desc:"Especiado y oscuro. Pimienta vibrante y cacao adictivo.",tags:["especiado","oscuro","nocturno","rebelde","dulce"]},
  {id:9,name:"Eros",inspired:"Versace Eros",cat:"masculina",top:["menta","manzana verde","limÃ³n"],heart:["haba tonka","ambroxan"],base:["vainilla","cedro","vetiver"],desc:"Fresco y dulce con menta y vainilla envolvente. Poderoso y seductor.",tags:["dulce","fresco","seductor","fiesta","cita","joven"]},
  {id:10,name:"Fahrenheit",inspired:"Dior Fahrenheit",cat:"masculina",top:["nuez moscada","lavanda","cedro"],heart:["violeta","sÃ¡ndalo"],base:["cuero","Ã¡mbar","vetiver"],desc:"IcÃ³nico y atemporal. Cuero y violeta. Masculinidad cruda y sofisticada.",tags:["cuero","amaderado","maduro","oficina","clÃ¡sico"]},
  {id:11,name:"Good Girl",inspired:"CH Good Girl",cat:"femenina",top:["almendra","cafÃ©","bergamota"],heart:["tuberosa","jazmÃ­n","rosa"],base:["haba tonka","cacao","vainilla","sÃ¡ndalo"],desc:"Dualidad irresistible: flores luminosas y fondo oscuro de cafÃ© y cacao.",tags:["dulce","nocturno","sensual","cita","elegante","cafÃ©"]},
  {id:12,name:"212 VIP RosÃ©",inspired:"CH 212 VIP RosÃ©",cat:"femenina",top:["champÃ¡n rosado","pimienta rosa"],heart:["durazno","rosa"],base:["almizcle blanco"],desc:"Burbujeante y femenina. Fresca y coqueta como una noche de celebraciÃ³n.",tags:["fresco","fiesta","coqueto","joven","frutal"]},
  {id:13,name:"La Vie Est Belle",inspired:"LancÃ´me La Vie Est Belle",cat:"femenina",top:["grosella negra","pera"],heart:["iris","jazmÃ­n"],base:["pralinÃ©","vainilla","pachulÃ­"],desc:"Dulce y radiante con iris gourmand y pralinÃ©. Un abrazo de felicidad.",tags:["dulce","gourmand","elegante","versÃ¡til","diario","romÃ¡ntico"]},
  {id:14,name:"J'adore",inspired:"Dior J'adore",cat:"femenina",top:["pera","magnolia","durazno"],heart:["jazmÃ­n","tuberosa","rosa"],base:["almizcle","vainilla","cedro"],desc:"Bouquet floral lujoso. La quintaesencia de la feminidad elegante.",tags:["floral","elegante","clÃ¡sico","romÃ¡ntico","oficina"]},
  {id:15,name:"CH",inspired:"Carolina Herrera CH",cat:"femenina",top:["bergamota","pomelo"],heart:["pralinÃ©","canela","jazmÃ­n","rosa"],base:["gamuza","pachulÃ­","sÃ¡ndalo"],desc:"Sofisticada y cÃ¡lida con pralinÃ© especiado y cuero suave.",tags:["cÃ¡lido","elegante","oficina","sofisticado","especiado"]},
  {id:16,name:"Black Opium",inspired:"YSL Black Opium",cat:"femenina",top:["pera","pimienta rosa"],heart:["cafÃ©","jazmÃ­n","almendra"],base:["vainilla","pachulÃ­","cedro"],desc:"Adictiva y nocturna. CafÃ© intenso y vainilla dulce. Rock and roll.",tags:["dulce","nocturno","cafÃ©","adictivo","sensual","fiesta"]},
  {id:17,name:"Chance",inspired:"Chanel Chance",cat:"femenina",top:["pimienta rosa","piÃ±a"],heart:["jazmÃ­n","rosa"],base:["pachulÃ­","almizcle","vainilla"],desc:"Fresca y vivaz. Espontaneidad y feminidad moderna.",tags:["fresco","versÃ¡til","joven","diario","espontÃ¡neo"]},
  {id:18,name:"Bright Crystal",inspired:"Versace Bright Crystal",cat:"femenina",top:["granada","yuzu"],heart:["peonÃ­a","magnolia","loto"],base:["almizcle","Ã¡mbar","caoba"],desc:"Cristalina y luminosa con flores delicadas y granada fresca.",tags:["fresco","floral","delicado","diario","sutil","romÃ¡ntico"]},
  {id:19,name:"Amor Amor",inspired:"Cacharel Amor Amor",cat:"femenina",top:["grosella negra","naranja","mandarina"],heart:["rosa","albaricoque","jazmÃ­n"],base:["vainilla","haba tonka","Ã¡mbar"],desc:"Frutal, apasionada y juvenil. Frutas rojas y rosa con vainilla cÃ¡lida.",tags:["frutal","juvenil","dulce","romÃ¡ntico","casual"]},
  {id:20,name:"Flowerbomb",inspired:"Viktor & Rolf Flowerbomb",cat:"femenina",top:["tÃ©","bergamota"],heart:["orquÃ­dea","jazmÃ­n","rosa"],base:["pachulÃ­","almizcle","vainilla"],desc:"ExplosiÃ³n floral adictiva. OrquÃ­dea y rosa en pachulÃ­ y vainilla.",tags:["floral","dulce","sensual","elegante","cita"]},
  {id:21,name:"Baccarat Rouge",inspired:"MFK Baccarat Rouge 540",cat:"unisex",top:["azafrÃ¡n","jazmÃ­n"],heart:["Ã¡mbar","ambroxan"],base:["resina de abeto","cedro","azÃºcar"],desc:"Luminoso y etÃ©reo. AzafrÃ¡n cristalino y Ã¡mbar dulce. MÃ¡gico e hipnotizante.",tags:["dulce","Ãºnico","elegante","cita","nocturno","lujoso"]},
  {id:22,name:"Oud Wood",inspired:"Tom Ford Oud Wood",cat:"unisex",top:["palo de rosa","cardamomo"],heart:["oud","sÃ¡ndalo","vetiver"],base:["haba tonka","vainilla","Ã¡mbar"],desc:"Sofisticado y misterioso. Oud suave y maderas exÃ³ticas. Lujo silencioso.",tags:["amaderado","sofisticado","elegante","oficina","maduro","lujoso"]},
  {id:23,name:"Erba Pura",inspired:"Xerjoff Erba Pura",cat:"unisex",top:["naranja","bergamota","limÃ³n"],heart:["frutas"],base:["almizcle blanco","vainilla","Ã¡mbar"],desc:"CÃ­tricos vibrantes y frutas jugosas sobre vainilla cremosa. Pura alegrÃ­a.",tags:["frutal","fresco","alegre","versÃ¡til","diario","cÃ­trico"]},
  {id:24,name:"Tobacco Vanille",inspired:"Tom Ford Tobacco Vanille",cat:"unisex",top:["tabaco","especiadas"],heart:["vainilla","cacao","haba tonka"],base:["frutas secas","amaderado"],desc:"CÃ¡lido y opulento. Tabaco dulce y vainilla rica. Lujo junto a la chimenea.",tags:["cÃ¡lido","dulce","nocturno","maduro","lujoso","especiado"]},
  {id:25,name:"Kirke",inspired:"Tiziana Terenzi Kirke",cat:"unisex",top:["maracuyÃ¡","durazno","pera","frambuesa"],heart:["lirio de los valles"],base:["almizcle","sÃ¡ndalo","vainilla","pachulÃ­"],desc:"Frutal y luminoso con corazÃ³n floral y base cremosa. Elegancia natural.",tags:["frutal","fresco","elegante","versÃ¡til","diario","romÃ¡ntico"]},
  {id:26,name:"Arabian Tonka",inspired:"Montale Arabians Tonka",cat:"unisex",top:["azafrÃ¡n","bergamota"],heart:["oud","rosa bÃºlgara"],base:["haba tonka","Ã¡mbar","almizcle blanco"],desc:"Oriental y envolvente. AzafrÃ¡n dorado, rosa y tonka dulce. Noches Ã¡rabes.",tags:["oriental","dulce","nocturno","elegante","lujoso","cÃ¡lido"]}
];

const PRICES = {s30:'$30.000',s50:'$46.000',s100:'$70.000'};
const PROMO = '3 frascos de 30ml por $80.000';
const WA = '573156753404';

let isOpen = false;
let state = 'welcome'; // welcome, ask_who, ask_vibe, recommend, chosen, objection, closing
let context = { who: null, vibe: null, occasion: null, chosen: null, recommendations: [] };

const $ = id => document.getElementById(id);
const msgs = () => $('ee-chat-messages');
const qr = () => $('ee-quick-replies');

function toggle() {
  isOpen = !isOpen;
  $('ee-chat-window').classList.toggle('open', isOpen);
  if (isOpen) {
    $('ee-chat-badge').style.display = 'none';
    if (state === 'welcome') { setTimeout(greet, 400); }
  }
}

function addMsg(text, sender='bot') {
  const d = document.createElement('div');
  d.className = 'ee-msg ' + sender;
  d.innerHTML = text;
  msgs().appendChild(d);
  msgs().scrollTop = msgs().scrollHeight;
}

function showTyping() {
  const d = document.createElement('div');
  d.className = 'ee-typing';
  d.id = 'ee-typing';
  d.innerHTML = '<span></span><span></span><span></span>';
  msgs().appendChild(d);
  msgs().scrollTop = msgs().scrollHeight;
}
function hideTyping() { const t = $('ee-typing'); if(t) t.remove(); }

function botSay(text, delay=600) {
  return new Promise(r => {
    showTyping();
    setTimeout(() => { hideTyping(); addMsg(text); r(); }, delay);
  });
}

function setQuickReplies(options) {
  const c = qr();
  c.innerHTML = '';
  options.forEach(o => {
    const b = document.createElement('button');
    b.className = 'ee-quick-btn';
    b.textContent = o.label;
    b.onclick = () => { handleQuick(o); };
    c.appendChild(b);
  });
}
function clearQuick() { qr().innerHTML = ''; }

// â”€â”€ Greeting â”€â”€
async function greet() {
  state = 'ask_who';
  await botSay('Â¡Hola! ğŸ‘‹ Bienvenido/a a <span class="ee-fragrance-name">Empire Essence</span> âœ¨');
  await botSay('Soy tu asesor de fragancias. Tenemos perfumes inspirados en las mejores marcas del mundo, con una calidad y duraciÃ³n increÃ­bles. ğŸŒŸ');
  await botSay('CuÃ©ntame, Â¿para quiÃ©n estÃ¡s buscando la fragancia?');
  setQuickReplies([
    {label:'Para mÃ­ (hombre)', value:'masculina', action:'who'},
    {label:'Para mÃ­ (mujer)', value:'femenina', action:'who'},
    {label:'Para regalar', value:'regalo', action:'who'},
    {label:'Algo unisex', value:'unisex', action:'who'}
  ]);
}

function handleQuick(o) {
  clearQuick();
  addMsg(o.label, 'user');
  route(o.action, o.value, o.label);
}

async function route(action, value, label) {
  switch(action) {
    case 'who': await handleWho(value); break;
    case 'who_gift': await handleWhoGift(value); break;
    case 'vibe': await handleVibe(value); break;
    case 'pick': await handlePick(value); break;
    case 'size': await handleSize(value); break;
    case 'objection': await handleObjection(value); break;
    case 'more': await showMore(); break;
    case 'whatsapp': await goWhatsApp(); break;
    case 'restart': await restart(); break;
    case 'promo': await showPromo(); break;
  }
}

// â”€â”€ Flow â”€â”€
async function handleWho(v) {
  if (v === 'regalo') {
    state = 'ask_who';
    await botSay('Â¡QuÃ© lindo detalle! ğŸ Â¿Para quiÃ©n es el regalo?');
    setQuickReplies([
      {label:'Hombre', value:'masculina', action:'who_gift'},
      {label:'Mujer', value:'femenina', action:'who_gift'},
      {label:'No sÃ©, algo unisex', value:'unisex', action:'who_gift'}
    ]);
    return;
  }
  context.who = v;
  state = 'ask_vibe';
  await askVibe();
}

async function handleWhoGift(v) {
  context.who = v;
  state = 'ask_vibe';
  await askVibe();
}

async function askVibe() {
  await botSay('Â¡Perfecto! Ahora cuÃ©ntame, Â¿quÃ© tipo de aroma te llama mÃ¡s la atenciÃ³n?');
  setQuickReplies([
    {label:'ğŸ‹ Fresco/CÃ­trico', value:'fresco', action:'vibe'},
    {label:'ğŸŒ¸ Floral/RomÃ¡ntico', value:'floral', action:'vibe'},
    {label:'ğŸ« Dulce/Gourmand', value:'dulce', action:'vibe'},
    {label:'ğŸªµ Amaderado/Elegante', value:'amaderado', action:'vibe'},
    {label:'ğŸŒ™ Nocturno/Sensual', value:'nocturno', action:'vibe'},
    {label:'ğŸ‰ Para fiesta', value:'fiesta', action:'vibe'},
    {label:'ğŸ’¼ Para oficina', value:'oficina', action:'vibe'},
    {label:'No sÃ©, recomiÃ©ndame', value:'versÃ¡til', action:'vibe'}
  ]);
}

async function handleVibe(v) {
  context.vibe = v;
  state = 'recommend';
  await recommend();
}

async function recommend() {
  const who = context.who;
  const vibe = context.vibe;

  let pool = catalog.filter(f => f.cat === who || f.cat === 'unisex');
  if (who === 'unisex') pool = catalog.filter(f => f.cat === 'unisex');

  // Score by tag matching
  let scored = pool.map(f => {
    let score = 0;
    if (f.tags.includes(vibe)) score += 3;
    // secondary matches
    const related = {
      'fresco':['cÃ­trico','acuÃ¡tico','deportivo','diario','versÃ¡til'],
      'floral':['romÃ¡ntico','delicado','elegante'],
      'dulce':['gourmand','cÃ¡lido','adictivo'],
      'amaderado':['elegante','sofisticado','maduro','cuero'],
      'nocturno':['sensual','oscuro','adictivo','seductor'],
      'fiesta':['joven','festivo','tropical','nocturno'],
      'oficina':['elegante','versÃ¡til','clÃ¡sico','sofisticado'],
      'versÃ¡til':['diario','fresco','elegante']
    };
    (related[vibe]||[]).forEach(r => { if(f.tags.includes(r)) score += 1; });
    return {...f, score};
  });

  scored.sort((a,b) => b.score - a.score);
  const recs = scored.slice(0,3);
  context.recommendations = recs;

  await botSay(`Â¡Excelente elecciÃ³n! BasÃ¡ndome en lo que me cuentas, te recomiendo estas fragancias ğŸ”¥`);

  for (let i = 0; i < recs.length; i++) {
    const f = recs[i];
    const allNotes = [...f.top, ...f.heart, ...f.base.slice(0,2)].join(', ');
    await botSay(
      `<div class="ee-product-card">
        <h4>${i+1}. ${f.name}</h4>
        <div class="ee-inspired">Inspirado en ${f.inspired}</div>
        <div class="ee-notes">
          <span class="ee-note-label">Notas:</span> ${allNotes}<br>
          ${f.desc}
        </div>
      </div>`, 500
    );
  }

  await botSay('Â¿CuÃ¡l te llama mÃ¡s la atenciÃ³n? ğŸ˜Š');
  setQuickReplies([
    ...recs.map((f,i) => ({label: f.name, value: f.id, action:'pick'})),
    {label:'ğŸ”„ Ver otras opciones', value:null, action:'more'},
    {label:'ğŸ’¬ CuÃ©ntame mÃ¡s', value:null, action:'objection', label:'Â¿Son buenos?'}
  ]);
}

async function handlePick(id) {
  const f = catalog.find(p => p.id === id);
  context.chosen = f;
  state = 'chosen';

  await botSay(`Â¡Excelente gusto! <span class="ee-fragrance-name">${f.name}</span> es una fragancia espectacular ğŸŒŸ`);
  await botSay(
    `Estos son los tamaÃ±os disponibles:<br><br>
    ğŸ’§ <b>30ml</b> â€” <span class="ee-price">${PRICES.s30}</span> COP <i>(ideal para probar)</i><br>
    ğŸ’§ <b>50ml</b> â€” <span class="ee-price">${PRICES.s50}</span> COP <i>(tamaÃ±o perfecto)</i><br>
    ğŸ’§ <b>100ml</b> â€” <span class="ee-price">${PRICES.s100}</span> COP <i>(mÃ¡ximo rendimiento)</i><br><br>
    ğŸ”¥ <b>PROMO:</b> ${PROMO}`
  );
  await botSay('Â¿QuÃ© tamaÃ±o te gustarÃ­a?');
  setQuickReplies([
    {label:'30ml - $30.000', value:'30ml', action:'size'},
    {label:'50ml - $46.000', value:'50ml', action:'size'},
    {label:'100ml - $70.000', value:'100ml', action:'size'},
    {label:'ğŸ”¥ Promo 3Ã—30ml', value:'promo', action:'promo'},
    {label:'Â¿CuÃ¡nto dura?', value:'durabilidad', action:'objection'},
    {label:'Â¿Es original?', value:'calidad', action:'objection'}
  ]);
}

async function handleSize(size) {
  context.size = size;
  state = 'closing';
  const f = context.chosen;
  const price = size === '30ml' ? PRICES.s30 : size === '50ml' ? PRICES.s50 : PRICES.s100;

  await botSay(
    `Â¡Listo! Tu pedido serÃ­a:<br><br>
    âœ… <span class="ee-fragrance-name">${f.name}</span> â€” ${size}<br>
    ğŸ’° <b>${price} COP</b><br>
    ğŸšš EnvÃ­o a todo Colombia<br>
    ğŸ’³ Todos los mÃ©todos de pago<br><br>
    Â¿Te lo confirmo por WhatsApp? ğŸ“²`
  );
  setQuickReplies([
    {label:'âœ… SÃ­, pedir por WhatsApp', value:null, action:'whatsapp'},
    {label:'Agregar otra fragancia', value:null, action:'restart'},
    {label:'Quiero otro tamaÃ±o', value:context.chosen.id, action:'pick'}
  ]);
}

async function showPromo() {
  context.size = 'promo';
  state = 'closing';
  await botSay(
    `Â¡La promo es increÃ­ble! ğŸ”¥<br><br>
    âœ… <b>3 frascos de 30ml por ${PRICES.s30.replace('$30.000','$80.000')}</b><br>
    Puedes elegir 3 fragancias diferentes ğŸ˜<br><br>
    Te ahorras $10.000 y puedes variar entre aromas. Â¿Quieres continuar por WhatsApp para elegir tus 3 fragancias?`
  );
  setQuickReplies([
    {label:'âœ… SÃ­, armar mi combo', value:null, action:'whatsapp'},
    {label:'Ver mÃ¡s fragancias', value:null, action:'restart'}
  ]);
}

async function handleObjection(type) {
  if (type === 'durabilidad') {
    await botSay(
      `Â¡Gran pregunta! Nuestras fragancias tienen una <b>duraciÃ³n de 6 a 10 horas</b> dependiendo del perfume y tu piel. ğŸ’ª<br><br>
      Usamos concentraciones de alta calidad tipo <b>Eau de Parfum</b>. AdemÃ¡s, te recomiendo aplicar en puntos de pulso (muÃ±ecas, cuello, detrÃ¡s de las orejas) para maximizar la duraciÃ³n. ğŸ¯`
    );
  } else if (type === 'calidad') {
    await botSay(
      `Excelente pregunta ğŸ‘ Nuestros perfumes son <b>fragancias inspiradas</b> en las grandes marcas. No son copias ni falsificaciones.<br><br>
      Usamos <b>esencias de alta calidad</b> importadas que replican los acordes olfativos de las fragancias originales. La diferencia principal es que no pagas por la marca, el marketing ni el frasco lujoso â€” pagas por el <b>aroma</b>. âœ¨<br><br>
      Â¡Por eso ofrecemos calidad premium a precios accesibles!`
    );
  } else if (type === 'precio') {
    await botSay(
      `Entiendo tu inquietud ğŸ¤ Mira, un perfume original como ${context.chosen ? context.chosen.inspired : 'estos'} puede costar entre $300.000 y $1.200.000 COP.<br><br>
      Con nosotros obtienes <b>el mismo tipo de aroma</b> desde <span class="ee-price">${PRICES.s30}</span>. Â¡Y con la promo de ${PROMO}, es aÃºn mejor! ğŸ”¥`
    );
  }

  if (context.chosen) {
    setQuickReplies([
      {label:'30ml - $30.000', value:'30ml', action:'size'},
      {label:'50ml - $46.000', value:'50ml', action:'size'},
      {label:'100ml - $70.000', value:'100ml', action:'size'},
      {label:'ğŸ”¥ Promo 3Ã—30ml', value:'promo', action:'promo'}
    ]);
  } else {
    setQuickReplies([
      {label:'Â¡Convencido! RecomiÃ©ndame', value:'versÃ¡til', action:'vibe'},
      {label:'Ver catÃ¡logo', value:null, action:'restart'}
    ]);
  }
}

async function showMore() {
  // Show next 3 from pool
  const shown = new Set(context.recommendations.map(r=>r.id));
  const who = context.who;
  let pool = catalog.filter(f => (f.cat === who || f.cat === 'unisex') && !shown.has(f.id));
  if (pool.length === 0) {
    pool = catalog.filter(f => !shown.has(f.id)).slice(0,3);
  }
  const recs = pool.slice(0,3);
  if (recs.length === 0) {
    await botSay('Â¡Ya te mostrÃ© todas las opciones! Â¿Te gustÃ³ alguna de las anteriores? ğŸ˜Š');
    setQuickReplies([
      ...context.recommendations.map(f => ({label:f.name, value:f.id, action:'pick'})),
      {label:'ğŸ”„ Empezar de nuevo', value:null, action:'restart'}
    ]);
    return;
  }
  context.recommendations = [...context.recommendations, ...recs];

  for (const f of recs) {
    const allNotes = [...f.top, ...f.heart, ...f.base.slice(0,2)].join(', ');
    await botSay(
      `<div class="ee-product-card">
        <h4>${f.name}</h4>
        <div class="ee-inspired">Inspirado en ${f.inspired}</div>
        <div class="ee-notes">
          <span class="ee-note-label">Notas:</span> ${allNotes}<br>
          ${f.desc}
        </div>
      </div>`, 400
    );
  }

  setQuickReplies([
    ...recs.map(f => ({label:f.name, value:f.id, action:'pick'})),
    {label:'ğŸ”„ Ver mÃ¡s', value:null, action:'more'},
    {label:'Empezar de nuevo', value:null, action:'restart'}
  ]);
}

async function goWhatsApp() {
  const f = context.chosen;
  let msg = 'Â¡Hola Empire Essence! ğŸ‘‘ ';
  if (f && context.size && context.size !== 'promo') {
    msg += `Quiero pedir: ${f.name} (${f.inspired}) en ${context.size}. `;
  } else if (context.size === 'promo') {
    msg += 'Quiero la promo de 3Ã—30ml por $80.000. ';
  } else {
    msg += 'Quiero mÃ¡s informaciÃ³n sobre sus fragancias. ';
  }
  msg += 'Â¿Me ayudan?';

  const url = `https://wa.me/${WA}?text=${encodeURIComponent(msg)}`;

  await botSay(
    `Â¡Perfecto! ğŸ‰ Te redirijo a nuestro WhatsApp para confirmar tu pedido.<br><br>
    <a href="${url}" target="_blank" style="
      display:inline-block; background:linear-gradient(135deg,#25d366,#128c7e);
      color:#fff; padding:10px 20px; border-radius:24px; text-decoration:none;
      font-weight:600; font-size:14px;
    ">ğŸ“² Abrir WhatsApp</a><br><br>
    Â¡Gracias por elegir Empire Essence! âœ¨ğŸ‘‘`
  );
  setQuickReplies([
    {label:'ğŸ“² Abrir WhatsApp', value:null, action:'whatsapp'},
    {label:'Ver mÃ¡s fragancias', value:null, action:'restart'}
  ]);
}

async function restart() {
  context = { who:null, vibe:null, occasion:null, chosen:null, recommendations:[] };
  state = 'ask_who';
  await botSay('Â¡Claro! Empecemos de nuevo ğŸ˜Š Â¿Para quiÃ©n buscas la fragancia?');
  setQuickReplies([
    {label:'Para mÃ­ (hombre)', value:'masculina', action:'who'},
    {label:'Para mÃ­ (mujer)', value:'femenina', action:'who'},
    {label:'Para regalar', value:'regalo', action:'who'},
    {label:'Algo unisex', value:'unisex', action:'who'}
  ]);
}

// â”€â”€ Free text handling â”€â”€
function handleFreeText(text) {
  const t = text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

  // Check for specific fragrance name
  const match = catalog.find(f => t.includes(f.name.toLowerCase()));
  if (match) {
    clearQuick();
    addMsg(text, 'user');
    handlePick(match.id);
    return;
  }

  // Keyword mapping
  const keywords = {
    'fresc':['fresco','vibe'], 'citric':['fresco','vibe'], 'acuatic':['fresco','vibe'],
    'floral':['floral','vibe'], 'romantic':['floral','vibe'], 'rosa':['floral','vibe'],
    'dulce':['dulce','vibe'], 'vaini':['dulce','vibe'], 'gourmand':['dulce','vibe'],
    'mader':['amaderado','vibe'], 'elegan':['amaderado','vibe'], 'cuero':['amaderado','vibe'],
    'noche':['nocturno','vibe'], 'sensual':['nocturno','vibe'], 'seduc':['nocturno','vibe'],
    'fiesta':['fiesta','vibe'], 'party':['fiesta','vibe'], 'rumba':['fiesta','vibe'],
    'oficina':['oficina','vibe'], 'trabajo':['oficina','vibe'], 'formal':['oficina','vibe'],
    'hombre':['masculina','who'], 'mascul':['masculina','who'], 'novio':['masculina','who'], 'papa':['masculina','who'], 'esposo':['masculina','who'],
    'mujer':['femenina','who'], 'femeni':['femenina','who'], 'novia':['femenina','who'], 'mama':['femenina','who'], 'esposa':['femenina','who'],
    'unisex':['unisex','who'],
    'regalo':['regalo','who'],
    'precio':['precio','objection'], 'caro':['precio','objection'], 'costoso':['precio','objection'],
    'original':['calidad','objection'], 'calidad':['calidad','objection'], 'copia':['calidad','objection'],
    'dura':['durabilidad','objection'], 'duracion':['durabilidad','objection'],
    'whatsapp':['wa','special'], 'pedir':['wa','special'], 'comprar':['wa','special'],
    'promo':['promo','special'], 'descuento':['promo','special'], 'oferta':['promo','special'],
    'hola':['hi','special'], 'buenas':['hi','special'], 'buenos':['hi','special'],
    'catalogo':['cat','special'], 'todo':['cat','special']
  };

  for (const [kw, [val, act]] of Object.entries(keywords)) {
    if (t.includes(kw)) {
      clearQuick();
      addMsg(text, 'user');
      if (act === 'special') {
        if (val === 'wa') goWhatsApp();
        else if (val === 'promo') showPromo();
        else if (val === 'hi') {
          if (state === 'welcome') greet();
          else botSay('Â¡Hola de nuevo! ğŸ˜Š Â¿En quÃ© te puedo ayudar?');
        }
        else if (val === 'cat') restart();
      } else {
        route(act, val, text);
      }
      return;
    }
  }

  // Fallback
  clearQuick();
  addMsg(text, 'user');
  botSay('Â¡Entiendo! ğŸ˜Š DÃ©jame ayudarte mejor. Â¿QuÃ© tipo de fragancia te interesa?').then(() => {
    setQuickReplies([
      {label:'ğŸ‹ Fresco', value:'fresco', action:'vibe'},
      {label:'ğŸŒ¸ Floral', value:'floral', action:'vibe'},
      {label:'ğŸ« Dulce', value:'dulce', action:'vibe'},
      {label:'ğŸªµ Amaderado', value:'amaderado', action:'vibe'},
      {label:'ğŸŒ™ Nocturno', value:'nocturno', action:'vibe'},
      {label:'Ver todo el catÃ¡logo', value:null, action:'restart'}
    ]);
  });
}

function sendUserInput() {
  const input = $('ee-chat-input');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  handleFreeText(text);
}

// Enter key
document.addEventListener('DOMContentLoaded', () => {
  $('ee-chat-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); sendUserInput(); }
  });

  // Show badge after 3s if not opened
  setTimeout(() => {
    if (!isOpen) $('ee-chat-badge').style.display = 'flex';
  }, 3000);
});

return { toggle, sendUserInput };
})();
</script>
</body>
</html>
